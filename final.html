<!DOCTYPE html>
<html>
  <head>
    <title>India State User Count Map</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <style>
      #map {
        height: 100vh;
        width: 100%;
        background-color: #1a1a1a;
      }

      .leaflet-container {
        /* Sets the color of non-map areas (e.g., oceans) to dark */
        background-color: #1a1a1a !important;
      }

      /* ðŸŒŸ LEGEND STYLING ðŸŒŸ */
      .legend {
        line-height: 18px;
        color: #555;
        background: white; /* White background for visibility */
        padding: 6px 8px;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
        border-radius: 5px;
      }
      .legend i {
        width: 18px;
        height: 18px;
        float: left;
        margin-right: 8px;
        opacity: 0.7;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>

    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>
    <script type="text/javascript" src="./leaflet.mask.js"></script>

    <script>
      // === 1. DATA ===
      const userDataByState = {
        Haryana: 1000,
        Delhi: 2000,
        Maharashtra: 15000,
        Karnataka: 8000,
        "Uttar Pradesh": 12000,
        Rajasthan: 4000,
        Gujarat: 6000,
        "West Bengal": 7500,
        "Madhya Pradesh": 5000,
        "Tamil Nadu": 9000,
      };

      // Define the grades/bins for the color scale. These must match the getColor function.
      const grades = [0, 1000, 3000, 5000, 7000, 9000, 12000];

      // === 2. HELPER FUNCTIONS ===

      // Define color gradient based on user count (Choropleth styling)
      function getColor(d) {
        // NOTE: The thresholds here MUST match the grades array for the legend.
        return d > 12000
          ? "#800026" // Dark Red (Highest Count)
          : d > 9000
          ? "#BD0026"
          : d > 7000
          ? "#E31A1C"
          : d > 5000
          ? "#FC4E2A"
          : d > 3000
          ? "#FD8D3C"
          : d > 1000
          ? "#FEB24C"
          : "#ffee00"; // Light Yellow (Lowest Count)
      }

      // Apply style to each state polygon
      function style(feature) {
        // const stateCode = feature.properties.NAME_1 || "default";
        const stateCode = feature.id || "default";
        const userCount = userDataByState[stateCode] || 0;

        return {
          fillColor: getColor(userCount),
          weight: 1,
          opacity: 1,
          color: "black",
          dashArray: "3",
          fillOpacity: 0.7,
        };
      }

      // === 3. MAP INITIALIZATION ===
      const map = L.map("map").setView([23.5, 78.5], 4);

      // Use a dark base layer
      L.tileLayer(
        "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",
        {
          attribution: "&copy; CARTO",
          subdomains: "abcd",
          maxZoom: 19,
        }
      ).addTo(map);

      // Hiding the external world by restricting view bounds
      const indiaBounds = L.latLngBounds(L.latLng(6.5, 68), L.latLng(37, 98));
      map.setMaxBounds(indiaBounds);
      map.options.minZoom = 4;

      // === 4. ADD THE LEGEND CONTROL ===
      function addLegend() {
        // Create a custom control
        const legend = L.control({ position: "bottomright" });

        legend.onAdd = function (map) {
          // Create the HTML div element for the legend
          const div = L.DomUtil.create("div", "info legend");
          const labels = [];
          let from, to;

          // Loop through our data intervals (grades) and generate a label with a colored square for each
          for (let i = 0; i < grades.length; i++) {
            from = grades[i];
            to = grades[i + 1];

            labels.push(
              '<i style="background:' +
                getColor(from + 1) +
                '"></i> ' +
                from.toLocaleString() +
                (to ? "&ndash;" + to.toLocaleString() : "+")
            );
          }

          // Add title and join labels
          div.innerHTML =
            "<h4>User Count (Choropleth)</h4>" + labels.join("<br>");
          return div;
        };

        legend.addTo(map);
      }

      // Call the function to add the legend
      addLegend();

      // === 5. ADD GEOJSON LAYER (Choropleth) ===

      fetch("states2.geojson")
        .then((response) => response.json())
        .then((geojsonData) => {
          L.geoJson(geojsonData, {
            style: style,
            onEachFeature: function (feature, layer) {
              // const stateCode = feature.properties.NAME_1;
              // const stateName = feature.properties.NAME_1 || "Unknown State";
              const stateCode = feature.id;
              const stateName = feature.id || "Unknown State";
              const userCount = userDataByState[stateCode] || 0;

              layer.bindPopup(
                "<b>" +
                  stateName +
                  "</b><br>Users: " +
                  userCount.toLocaleString()
              );

              // Optional: Highlight on hover
              layer.on({
                mouseover: function (e) {
                  e.target.setStyle({
                    // weight: 2,
                    // color: "#666",
                    dashArray: "",
                    // fillOpacity: 0.9,
                  });
                  e.target.bringToFront();
                },
                // mouseout: function (e) {
                // L.geoJson.resetStyle(e.target);
                // },
              });
            },
          }).addTo(map);
          // L.mask(geojsonData, {}).addTo(map);

          L.mask(geojsonData, {
            fillColor: "#000", // Match your map background color (dark)
            fillOpacity: 1,
            stroke: false,
            interactive: false,
            // These two options cause the error:
            fitBounds: false,
            restrictBounds: false,
          }).addTo(map);
        })
        .catch((error) => console.error("Error fetching GeoJSON:", error));
    </script>
  </body>
</html>
