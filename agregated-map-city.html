<!DOCTYPE html>
<html>
  <head>
    <title>India City User Density Map</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <style>
      #map {
        height: 100vh;
        width: 100%;
        background-color: #1a1a1a;
      }

      .leaflet-container {
        /* Sets the color of non-map areas (e.g., oceans) to dark */
        background-color: #1a1a1a !important;
      }
    </style>
  </head>
  <body>
    <div id="map">
      <p style="text-align: center; padding-top: 50px; color: white">
        Loading map data... If this persists, check console for errors.
      </p>
    </div>

    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>

    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

    <script type="text/javascript" src="/leaflet.mask.js"></script>

    <script>
      const map = L.map("map").setView([23.5, 78.5], 5);

      // === 1. MAP INITIALIZATION ===

      function initializeMap() {
        // Use a dark base layer
        L.tileLayer(
          "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",
          {
            attribution: "&copy; CARTO",
            subdomains: "abcd",
            maxZoom: 19,
          }
        ).addTo(map);

        // Restrict view bounds (India)
        const indiaBounds = L.latLngBounds(L.latLng(6.5, 68), L.latLng(37, 98));
        map.setMaxBounds(indiaBounds);
        map.options.minZoom = 4;
      }

      // === 2. ADD GEOJSON LAYER (State Borders for Context) ===

      async function loadStateBorders() {
        try {
          const response = await fetch("states2.geojson");
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const geojsonData = await response.json();

          L.geoJson(geojsonData, {
            style: {
              fill: false, // No fill
              weight: 1,
              opacity: 0.8,
              color: "#999999", // Light grey border
            },
            interactive: false,
          }).addTo(map);
        } catch (error) {
          console.error("Error fetching GeoJSON (states2.geojson):", error);
        }
      }

      // === 3. ADD HEATMAP LAYER (City Coordinates) ===

      async function loadHeatmap() {
        try {
          const response = await fetch("parsed_coordinates.json");
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const coordinateData = await response.json();

          if (coordinateData.length === 0) {
            console.warn("Coordinate data is empty. Cannot draw heatmap.");
            return;
          }

          // Convert list of [lat, lon] to Heatmap Layer
          L.heatLayer(coordinateData, {
            radius: 15,
            blur: 20,
            maxZoom: 1,
            // ðŸŒŸ Updated Gradient for Yellow/Gold Shades ðŸŒŸ
            gradient: {
              0.0: "#FFFACD", // Very Light Yellow (Low Density)
              0.3: "#FFD700", // Gold
              0.6: "#FFC400", // Darker Gold
              1.0: "#B8860B", // Deep Amber (High Density)
            },
          }).addTo(map);
        } catch (error) {
          console.error(
            "Error fetching coordinate data (parsed_coordinates.json):",
            error
          );
          alert(
            "Could not load coordinate data for heatmap. Check console for details."
          );
        }
      }

      async function maskMap() {
        try {
          const response = await fetch("states2.geojson");
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const geojsonData = await response.json();

          if (L.mask) {
            L.mask(geojsonData, {
              fillColor: "#000",
              fillOpacity: 1,
              stroke: false,
              interactive: false,
              fitBounds: false,
              restrictBounds: false,
            }).addTo(map);
          } else {
            console.warn("Leaflet.mask library not loaded. Masking skipped.");
          }
        } catch (error) {
          console.error(
            "Leaflet.mask library not loaded. Masking skipped.",
            error
          );
        }
      }
      // === 4. MAIN EXECUTION ===

      function main() {
        initializeMap();
        loadStateBorders();
        loadHeatmap();
        maskMap();
      }

      main();
    </script>
  </body>
</html>
