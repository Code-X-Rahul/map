<!DOCTYPE html>
<html>
  <head>
    <title>India State User Count Choropleth Map</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />

    <style>
      #map {
        height: 100vh;
        width: 100%;
        background-color: #1a1a1a;
      }

      /* Sets the color of non-map areas (e.g., oceans/outside bounds) to dark */
      .leaflet-container {
        background-color: #1a1a1a !important;
      }

      /* Legend Styling */
      .legend {
        line-height: 18px;
        color: #555;
        background: white;
        padding: 6px 8px;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
        border-radius: 5px;
      }
      .legend i {
        width: 18px;
        height: 18px;
        float: left;
        margin-right: 8px;
        opacity: 0.8; /* Slightly more opaque than the map layer */
        border: 1px solid #ccc;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>

    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>

    <script>
      // Define the color bins/grades (must match the getColor function)
      const grades = [0, 1000, 3000, 5000, 7000, 9000, 12000];
      let userCountData = {}; // Will be populated by fetch call

      // === 1. HELPER FUNCTIONS: STYLING & COLORING ===

      function getColor(d) {
        // Colors from light yellow (low count) to dark red (high count)
        return d > 12000
          ? "#800026"
          : d > 9000
          ? "#BD0026"
          : d > 7000
          ? "#E31A1C"
          : d > 5000
          ? "#FC4E2A"
          : d > 3000
          ? "#FD8D3C"
          : d > 1000
          ? "#FEB24C"
          : "#FFEDA0";
      }

      // Applies the style to each state polygon
      function style(feature) {
        // const stateCode = feature.properties.ST_CODE; // Assumes your GeoJSON uses 'ST_CODE'
        const stateCode = feature.id; // Assumes your GeoJSON uses 'ST_CODE'
        const userCount = userCountData[stateCode] || 0;

        return {
          fillColor: getColor(userCount),
          weight: 2,
          opacity: 1,
          color: "white", // White border between states
          dashArray: "3",
          fillOpacity: 0.7,
        };
      }

      // Handles user interaction (hover, popup) on each state
      function onEachFeature(feature, layer) {
        // const stateCode = feature.properties.ST_CODE;
        // const stateName = feature.properties.ST_NAME || "State Name Missing";
        const stateCode = feature.id;
        const stateName = feature.id || "State Name Missing";
        const userCount = userCountData[stateCode] || 0;

        layer.bindPopup(
          "<b>" + stateName + "</b><br>Users: " + userCount.toLocaleString()
        );

        layer.on({
          // Highlight state on hover
          mouseover: function (e) {
            e.target.setStyle({
              weight: 5,
              color: "#FFD700",
              dashArray: "",
              fillOpacity: 0.9,
            });
            e.target.bringToFront();
          },
          // Reset style when mouse moves out
          mouseout: function (e) {
            // Use a function to reset style based on the feature data
            layer.setStyle(style(feature));
          },
        });
      }

      // === 2. MAP SETUP & LEGEND ===

      function setupMap(geojsonData) {
        // Define India's boundary box for map control
        const southWest = L.latLng(6.5, 68);
        const northEast = L.latLng(37, 98);
        const indiaBounds = L.latLngBounds(southWest, northEast);

        // Initialize map, fit to bounds
        const map = L.map("map").fitBounds(indiaBounds);

        // ðŸ”’ Boundary Restriction: Only show India
        map.setMaxBounds(indiaBounds);
        map.options.minZoom = 4;

        // Dark Base Layer
        L.tileLayer(
          "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",
          {
            attribution: "&copy; CARTO",
            subdomains: "abcd",
            maxZoom: 19,
          }
        ).addTo(map);

        // Add the GeoJSON Layer (Choropleth)
        L.geoJson(geojsonData, {
          style: style,
          onEachFeature: onEachFeature,
        }).addTo(map);

        // Add the Legend Control
        const legend = L.control({ position: "bottomright" });

        legend.onAdd = function (map) {
          const div = L.DomUtil.create("div", "info legend");
          const labels = [];
          let from, to;

          for (let i = 0; i < grades.length; i++) {
            from = grades[i];
            to = grades[i + 1];

            labels.push(
              '<i style="background:' +
                getColor(from + 1) +
                '"></i> ' +
                from.toLocaleString() +
                (to ? "&ndash;" + to.toLocaleString() : "+")
            );
          }

          div.innerHTML =
            "<h4>User Count (Choropleth)</h4>" + labels.join("<br>");
          return div;
        };
        legend.addTo(map);
      }

      // === 3. DATA FETCHING AND EXECUTION ===
      async function initApp() {
        try {
          // 1. Fetch User Data
          const userResponse = await fetch("userData.json");
          if (!userResponse.ok) throw new Error("Failed to load userData.json");
          userCountData = await userResponse.json();

          // 2. Fetch GeoJSON Data
          const geoResponse = await fetch("states2.geojson");
          if (!geoResponse.ok) throw new Error("Failed to load india.geojson");
          const geojsonData = await geoResponse.json();

          // 3. Initialize the Map
          setupMap(geojsonData);
        } catch (error) {
          console.error("Critical Error during map initialization:", error);
          alert(
            "Map failed to load due to missing data files. Ensure 'india.geojson' and 'userData.json' are correctly placed and your server is running."
          );
        }
      }

      initApp();
    </script>
  </body>
</html>
